# Autotools - A Practioner's Guide to GNU Autconf, Automake, and Libtool 读书笔记

### AC_PREREQ(version)

检查 Autoconf 最低版本，这是唯一可以写在 `AC_INIT` 之前的宏（意思是这一般是写在 configure.ac 中的第一个宏）

### AC_INIT(package, version, [bug-report], [tarname], [url])

初始化 Authconf 系统，其中 `bug-report`， `tarname`， `url` 三个参数可选。默认情况下，Autoconf 声称的 tar 包的文件名是 `package-version.tar.gz`。
`bug-report` 一般是 Email 地址，但也可以是其他内容。`version` 不规定版本的格式，任何文字都可以是版本。`url` 则通常是项目的网址，通过 `configure --help` 可以看到。

### AC_CONFIG_SRCDIR(unique-file-in-source-dir)

这个宏其实只是一个防呆测试，防止 `configure` 命令找到错误的源代码目录（例如用户传入了错误的 `--srcdir` 参数）。
因此，该方法尝试搜索源码目录中一个独有的源码文件，通过检测它的存在性来确定源码目录是否正确。

#### AC_CONFIG_XXXS(tag..., [commands], [init-cmds])

Autoconf 有四种实例化宏，分别是 `AC_CONFIG_FILES`，`AC_CONFIG_HEADERS`，`AC_CONFIG_COMMANDS`，`AC_CONFIG_LINKS`，此类宏接受一组文件或者标签。`configure` 脚本负责为他们通过模版生成实际的文件
（有些老版本的 Autconf 还在用 `AC_CONFIG_HEADER` 宏，这个宏没有它的复数版本更强大）。
例如 `AC_CONFIG_HEADERS([config.h])`，它可以被展开成为 `AC_CONFIG_HEADERS([config.h:config.h.in])`，即 `config.h` 通过模版文件 `config.h.in` 生成。
也可以写 `AC_CONFIG_HEADERS([config.h:cfg0:cfg1:cfg2])`，那么 `config.h` 将由 `cfg0`，`cfg1`，`cfg2` 三个模版文件按照顺序合成。

### AC_CONFIG_COMMANDS

这个实例化宏比较特别，它并不生成任何文件而是执行任意的 Shell 语句，但是它会被生成的 `config.status` 自动执行，或者也可以让 `config.status` 执行其中某个命令。
例如只要写了 `AC_CONFIG_COMMANDS([abc], [echo "Testing $mypkgname"], [mypkgname=$PACKAGE_NAME])`，
每次执行 `config.status` 的时候会自动执行 `abc` 命令来显示 `Testing test` 的字样。
可以通过 `config.status --help` 看到 `config.status` 支持 `abc` 这样一条命令。因此通过执行 `config.status abc` 也可以直接显示 `Testing test` 的字样。

### AC_CHECK_HEADERS

`AC_CHECK_HEADERS` 会通过 `autoheader` 生成 `config.h.in`，增加多个 `undef` 宏的语句。
例如 `AC_CHECK_HEADERS([unistd.h foobar.h])` 会生成这样的 `config.h.in`：

```c
#undef HAVE_UNISTD_H
#undef HAVE_FOOBAR_H
```

随即执行 `configure` 可以会检查 `unistd.h` 与 `foobar.h`，一般来说，前者总是存在的而后者并不存在，因此会得到这样的 `config.h`：

```c
#define HAVE_UNISTD_H 1
/* #undef HAVE_FOOBAR_H */
```

可以看到会自动生成 `HAVE_UNISTD_H` 这样一个宏，表示 `unistd.h` 已经找到，而 `HAVE_FOOBAR_H` 没有生成是因为 `foobar.h` 没有找到。可以在源码中 include `config.h` 来使用这些宏判定某些头文件是否存在，从而灵活应对，实现跨平台性。

### AC_SUBST(shell_var[, value])

定义模版文件中的 Autoconf 变量（不要和模版文件本身的变量混淆），在模版文件中通过前后增加 @ 来调用。

### AC_DEFINE(variable) / AC_DEFINE(variable, value[, description]) / AC_DEFINE_UNQUOTED(variable) / AC_DEFINE_UNQUOTED(variable, value[, description])

定义 C 预编译器的宏，AC_DEFINE 与 AC_DEFINE_UNQUOTED 功能相似，只是 AC_DEFINE_UNQUOTED 会利用 Shell 的语法展开 `value`。
由于 C 预编译器的宏可以有值也可以只有定义，因此 AC_DEFINE 也分成了两个版本。
至于 `description` 只是在 `autoheader` 生成的 `config.h.in` 的注释中会包含。

### AC_PROG_XXX([compiler-search-list])

此类宏用语检查某个工具的存在性，例如 `AC_PROG_CC` 检查 C 编译器的存在。可以传入多个参数用以检查多个编译器，例如 `AC_PROG_CC([cc cl gcc])`，也可以省略参数由 `configure` 自己搜索。
类似的宏还有 `AC_PROG_INSTALL`，`AC_PROG_INSTALL`，`AC_PROG_LEX`，`AC_PROG_YACC`，`AC_PROG_SED`，`AC_PROG_AWK` 等等。
`autoscan` 在生成 `configure.scan` 的时候也会根据源码中的文件后缀名来选择应该生成的宏去检查相应的工具的存在。
